<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Up - Hack Harry</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="background-layer"></div>

  <nav>
    <div class="logo">
      <a href="index.html" aria-label="Go to home page">HACK HARRY</a>
    </div>

    <!-- Hamburger Icon -->
    <div class="hamburger" id="hamburger" aria-label="Toggle navigation menu">&#9776;</div>
    

    <!-- Mobile Sidebar Menu -->
    <div class="mobile-menu" id="mobileMenu">
      <ul>
        <li><a href="games.html">Games</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="rules.html">Rules</a></li>
        <li id="login-link"> <a class="selected" href="login.html">Login</a></li>
        <li id="profile-link"> <a href="view_profile.html" aria-label="Go to profile and settings page">Profile</a></li>
      </ul>
    </div>

    <!-- Desktop Menu -->
    <ul class="desktop-menu">
      <li><a href="games.html">Games</a></li>
      <li><a href="leaderboard.html">Leaderboard</a></li>
      <li><a href="rules.html">Rules</a></li>
      <li id="login-link-Desktop"> <a class="active" href="login.html">Login</a></li>
      <li id="profile-link-Desktop"> <a href="view_profile.html" aria-label="Go to profile and settings page">Profile</a></li>
    </ul>
  </nav>

  <main class="auth-container">
    <h1>Create Account</h1>

   <form id="signup-form">

    <label for="country">Country</label>
    <select id="country" name="country" class="form-control" required></select>
    <div id="country-error" class="field-error-message"></div>


    <label for="username">Username</label>
    <input type="text" id="username" name="username" required placeholder="Pick a username" />
    <div id="username-error" class="field-error-message"></div>

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required placeholder="you@example.com" /><br>

    <label for="password">Password</label>
    <input type="password" id="password" name="password" required placeholder="Enter password" />
    <br>
    <br>

    <div class="g-recaptcha" data-sitekey="6Lfu61krAAAAAAphnHuSPZ7KBPQmSw5V8jY1QYBR"></div>
    <br>


    <button type="submit" class="cta-btn">Sign Up</button>
  </form>
    <br>
    <p>Already have an account? <a href="login.html">Login here</a></p>

    <!-- NO inline styles here! -->
    <div id="signup-error" class="auth-message"></div>

  </main>


<!--Script for hambrug menu-->
<script src="JS/menu.js"></script>

<!-- Script for reCAPTCHA-->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>


<script>
  const countries = [
    "Afghanistan", "Albania", "Algeria", "Andorra", "Angola",
    "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
    "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus",
    "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
    "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria",
    "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
    "Cape Verde", "Central African Republic", "Chad", "Chile", "China",
    "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica",
    "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark",
    "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador",
    "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia",
    "Ethiopia", "Fiji", "Finland", "France", "Gabon",
    "Gambia", "Georgia", "Germany", "Ghana", "Greece",
    "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
    "Haiti", "Honduras", "Hungary", "Iceland", "India",
    "Indonesia", "Iran", "Iraq", "Ireland", "Israel",
    "Italy", "CÃ´te d'Ivoire", "Jamaica", "Japan", "Jordan",
    "Kazakhstan", "Kenya", "Kiribati", "North Korea", "South Korea",
    "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon",
    "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania",
    "Luxembourg", "North Macedonia", "Madagascar", "Malawi", "Malaysia",
    "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania",
    "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco",
    "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar",
    "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand",
    "Nicaragua", "Niger", "Nigeria", "Norway", "Oman",
    "Pakistan", "Palau", "Panama", "Papua New Guinea", "Paraguay",
    "Peru", "Philippines", "Poland", "Portugal", "Qatar",
    "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia",
    "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia",
    "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore",
    "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa",
    "Spain", "Sri Lanka", "Sudan", "Suriname", "Eswatini",
    "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan",
    "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago",
    "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda",
    "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay",
    "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
    "Yemen", "Zambia", "Zimbabwe",
    "Kosovo", "Palestine"
  ];

  const countrySelect = document.getElementById('country');
  countries.forEach(country => {
    const option = document.createElement('option');
    option.value = country;
    option.textContent = country;
    if (country === "United Kingdom") {
      option.selected = true;
    }
    countrySelect.appendChild(option);
  });
</script>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
  import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeHdaniWc3CRKubme0AI0oIa5ulpO5N_M",
    authDomain: "hackharry-web.firebaseapp.com",
    databaseURL: "https://hackharry-web-default-rtdb.firebaseio.com",
    projectId: "hackharry-web",
    storageBucket: "hackharry-web.appspot.com",
    messagingSenderId: "556895511519",
    appId: "1:556895511519:web:97a50817f47e6ce2c69a6a",
    measurementId: "G-9FGDR7SMGV"
  };


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const analytics = getAnalytics(app);

  const form = document.getElementById('signup-form');
  const messageDiv = document.getElementById('signup-error');
  const usernameInput = form.username;
  const usernameErrorDiv = document.getElementById('username-error'); 

  const loginLink = document.getElementById('login-link');
  const profileLink = document.getElementById('profile-link');
  const loginLinkDesktop = document.getElementById('login-link-Desktop');
  const profileLinkDesktop = document.getElementById('profile-link-Desktop');



  onAuthStateChanged(auth, (user) => {
    if (user) {
      profileLink.style.display = 'list-item';
      profileLink.style.visibility = 'visible';
      loginLink.style.display = 'none';
      loginLink.style.visibility = 'hidden';

      profileLinkDesktop.style.display = 'list-item';
      profileLinkDesktop.style.visibility = 'visible';
      loginLinkDesktop.style.display = 'none';
      loginLinkDesktop.style.visibility = 'hidden';
    } else {
      profileLink.style.display = 'none';
      profileLink.style.visibility = 'hidden';
      loginLink.style.display = 'list-item';
      loginLink.style.visibility = 'visible';

      profileLinkDesktop.style.display = 'none';
      profileLinkDesktop.style.visibility = 'hidden';
      loginLinkDesktop.style.display = 'list-item';
      loginLinkDesktop.style.visibility = 'visible';

    }
  });

  // Online users code
  const userId = Math.random().toString(36).substring(2);
  const userRef = ref(db, "onlineUsers/" + userId);
  set(userRef, true);
  onDisconnect(userRef).remove();

  const usersRef = ref(db, "onlineUsers");
  onValue(usersRef, (snapshot) => {
    const count = snapshot.size || Object.keys(snapshot.val() || {}).length;
    document.getElementById("liveCount").innerText = count;
  });


  function clearMessage() {
    messageDiv.textContent = '';
    messageDiv.classList.remove('visible', 'error', 'success');
  }

  function clearUsernameError() {
    usernameErrorDiv.textContent = '';
    usernameErrorDiv.classList.remove('visible');
  }

  function showMessage(message, type = 'success') {
    messageDiv.textContent = message;
    messageDiv.classList.remove('error', 'success');
    messageDiv.classList.add(type, 'visible');
  }

  // Check if username exists by scanning all users (not recommended if DB is big)
  async function isUsernameTaken(username) {
    return new Promise((resolve) => {
      const usersRef = ref(db, "users");
      onValue(
        usersRef,
        (snapshot) => {
          const users = snapshot.val() || {};
          const usernameLower = username.toLowerCase();

          for (const uid in users) {
            const user = users[uid];
            if (user.username && user.username.toLowerCase() === usernameLower) {
              resolve(true);
              return; // stop iterating and resolve immediately
            }
          }

          resolve(false); // username not found
        },
        { onlyOnce: true }
      );
    });
  }


  usernameInput.addEventListener('blur', async () => {
    clearUsernameError();
    clearMessage();

    const username = usernameInput.value.trim();
    if (!username) return;

    if (!username.match(/^[a-zA-Z0-9_]+$/)) {
      usernameErrorDiv.textContent = 'Username can only contain letters, numbers, and underscores.';
      usernameErrorDiv.classList.add('visible');
      return;
    }

    const taken = await isUsernameTaken(username);
    if (taken) {
      usernameErrorDiv.textContent = 'Username already taken. Try another one.';
      usernameErrorDiv.classList.add('visible');
    } else {
      clearUsernameError();
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearUsernameError();
    clearMessage();

    const username = form.username.value.trim();
    const email = form.email.value.trim();
    const password = form.password.value.trim();

    // Check reCAPTCHA response
    const recaptchaResponse = grecaptcha.getResponse();
    if (!recaptchaResponse) {
      showMessage('Please verify that you are not a robot.', 'error');
      return;
    }

    if (!username.match(/^[a-zA-Z0-9_]+$/)) {
      usernameErrorDiv.textContent = 'Username can only contain letters, numbers, and underscores.';
      usernameErrorDiv.classList.add('visible');
      return;
    }

    const taken = await isUsernameTaken(username);
    if (taken) {
      usernameErrorDiv.textContent = 'Username already taken. Try another one.';
      usernameErrorDiv.classList.add('visible');
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Send verification email
      await sendEmailVerification(user);

      const country = form.country.value.trim();

      // Save to DB...
      await set(ref(db, "users/" + user.uid), {
        email: user.email,
        username: username,
        country: country,
        emailVerified: false,
        createdAt: new Date().toISOString()

      });

      showMessage('Account created! Verification email sent. Please check your inbox.', 'success');
      grecaptcha.reset();
      form.reset();
      setTimeout(() => {
        window.location.href = 'welcome.html';
      }, 4000);


    } catch (error) {
      if (error.code === 'auth/email-already-in-use') {
        showMessage('This account already exists. Try to login instead.', 'error');
      } else {
        showMessage(error.message, 'error');
      }
    }
  });
</script>



</body>
</html>

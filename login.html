<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Hack Harry</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">


</head>
<body>
  <div class="background-layer"></div>

  <nav>
    <div class="logo">
      <a href="index.html" aria-label="Go to home page">HACK HARRY</a>
    </div>

    <!-- Hamburger Icon -->
    <div class="hamburger" id="hamburger" aria-label="Toggle navigation menu">&#9776;</div>
    

    <!-- Mobile Sidebar Menu -->
    <div class="mobile-menu" id="mobileMenu">
      <ul>
        <li><a href="games.html">Games</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="rules.html">Rules</a></li>
        <li id="login-link"> <a class="selected" href="login.html">Login</a></li>
        <li id="profile-link"> <a href="view_profile.html" aria-label="Go to profile and settings page">Profile</a></li>
      </ul>
    </div>

    <!-- Desktop Menu -->
    <ul class="desktop-menu">
      <li><a href="games.html">Games</a></li>
      <li><a href="leaderboard.html">Leaderboard</a></li>
      <li><a href="rules.html">Rules</a></li>
      <li id="login-link-Desktop"> <a class="active" href="login.html">Login</a></li>
      <li id="profile-link-Desktop"> <a href="view_profile.html" aria-label="Go to profile and settings page">Profile</a></li>
    </ul>
  </nav>

  <main class="auth-container">
    <h1>Login</h1>

    <form id="login-form">
      <label for="login">Email</label>
      <input type="email" id="login" name="email" required placeholder="Enter your email" /><br>


      <label for="password">Password</label>
      <input type="password" id="password" required placeholder="Enter password" /><br>

      <!-- Show Password checkbox -->
      <div class="show-password-wrapper">
        <input type="checkbox" id="show-password" />
        <label class="text-display" for="show-password">Show password</label>
      </div>

      <div class="recaptcha-container">
        <div class="g-recaptcha" data-sitekey="6Lfu61krAAAAAAphnHuSPZ7KBPQmSw5V8jY1QYBR"></div>
      </div>
      <br>
      

      <button type="submit" class="cta-btn">Login</button>
    </form>

    <form id="forgot-password-form" style="display:none;">
      <label for="reset-email">Enter your email</label>
      <input type="email" id="reset-email" required placeholder="Email" /><br>
      <button type="submit" class="cta-btn">Reset Password</button>
      <br>
      <br>
      <p><a href="#" id="back-to-login">Back to Login</a></p>
    </form>


    <br>
    <p><a href="#" id="forgot-password-link">Forgot Password?</a></p>

    <p>Don't have an account? <a href="signup.html">Sign Up here</a></p>

    <!-- Inline error/success message -->
    <div id="authMessage" class="auth-message"></div>
  </main>



<!--Script for hambrug menu-->
<script src="JS/menu.js"></script>

<!-- Script for reCAPTCHA-->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, updateEmail } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
import { getDatabase, ref, onValue, onDisconnect, set, get, update, push } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyDeHdaniWc3CRKubme0AI0oIa5ulpO5N_M",
  authDomain: "hackharry-web.firebaseapp.com",
  databaseURL: "https://hackharry-web-default-rtdb.firebaseio.com",
  projectId: "hackharry-web",
  storageBucket: "hackharry-web.appspot.com",
  messagingSenderId: "556895511519",
  appId: "1:556895511519:web:97a50817f47e6ce2c69a6a",
  measurementId: "G-9FGDR7SMGV"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const analytics = getAnalytics(app);



// app config for hackharry-logs
const firebaseLogsConfig = {
  apiKey: "AIzaSyB0AuPckJOZsUTm1HI-_WgG7xpdzMIfMc4",
  authDomain: "hackharry-logs.firebaseapp.com", // same as firebaseConfig.authDomain
  databaseURL: "https://hackharry-logs-default-rtdb.firebaseio.com",
  projectId: "hackharry-logs",
  storageBucket: "hackharry-logs.firebasestorage.app",
  messagingSenderId: "1099120452841",
  appId: "1:1099120452841:web:8bc0ec8a74f2ea486c3c78"
};


// Initialize second app for logs
const logsApp = initializeApp(firebaseLogsConfig, "logsApp");
const logsDb = getDatabase(logsApp);


// Toggle Login/Profile links
  const loginLink = document.getElementById('login-link');
  const profileLink = document.getElementById('profile-link');
  const loginLinkDesktop = document.getElementById('login-link-Desktop');
  const profileLinkDesktop = document.getElementById('profile-link-Desktop');


const params = new URLSearchParams(window.location.search);
const redirectURL = params.get('redirect') || 'index.html';  // Default to home


let isLoggingInNow = false;

// Redirect if already logged in
onAuthStateChanged(auth, async (user) => {
  if (user && !isLoggingInNow) {
    
    const dbRef = ref(db, "users/" + user.uid);
    const snapshot = await get(dbRef);
    if (snapshot.exists()) {
      const dbData = snapshot.val();
      if (dbData.email !== user.email) {
        await update(dbRef, { email: user.email });
        console.log("Database email updated to match Auth email.");
      }
    }
    window.location.href = redirectURL;
  }
  if (user) {
    profileLink.style.display = 'list-item';
    profileLink.style.visibility = 'visible';
    loginLink.style.display = 'none';
    loginLink.style.visibility = 'hidden';

    profileLinkDesktop.style.display = 'list-item';
    profileLinkDesktop.style.visibility = 'visible';
    loginLinkDesktop.style.display = 'none';
    loginLinkDesktop.style.visibility = 'hidden';
  } else {
    
    profileLink.style.display = 'none';
    profileLink.style.visibility = 'hidden';
    loginLink.style.display = 'list-item';
    loginLink.style.visibility = 'visible';

    profileLinkDesktop.style.display = 'none';
    profileLinkDesktop.style.visibility = 'hidden';
    loginLinkDesktop.style.display = 'list-item';
    loginLinkDesktop.style.visibility = 'visible';

  }
});

// Manage online users count
const userId = Math.random().toString(36).substring(2);
const userRef = ref(db, "onlineUsers/" + userId);
set(userRef, true);
onDisconnect(userRef).remove();

const usersRef = ref(db, "onlineUsers");
onValue(usersRef, (snapshot) => {
  const count = snapshot.size || Object.keys(snapshot.val() || {}).length;
});

const passwordInput = document.getElementById('password');
const showPasswordCheckbox = document.getElementById('show-password');

showPasswordCheckbox.addEventListener('change', () => {
  if (showPasswordCheckbox.checked) {
    passwordInput.type = 'text';
  } else {
    passwordInput.type = 'password';
  }
});

const form = document.getElementById('login-form');
const authMessage = document.getElementById('authMessage');

const errorMessages = {
  'auth/invalid-credential': 'Error: Invalid credentials',
  'auth/user-not-found': 'Error: Invalid login credentials',
  'auth/wrong-password': 'Error: Incorrect password',
  'auth/invalid-email': 'Error: Invalid email address',
  'auth/user-disabled': 'User Account Disabled'

};

function getCustomErrorMessage(firebaseErrorMessage) {
  const match = firebaseErrorMessage.match(/\((auth\/[^\)]+)\)/);
  if (match) {
    const code = match[1];
    if (errorMessages[code]) {
      return errorMessages[code];
    }
  }
  return firebaseErrorMessage.replace(/^Firebase:\s*/, '').trim();
}

// Helper to check if input is an email
function isEmail(input) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
}

// gets IP address for logs in case of failed login attempts. This is used to protect users Security
async function getClientIp() {
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    return data.ip;
  } catch {
    return 'unknown';
  }
}


//Formats timestamp to make it readable
function getFormattedTimestamp() {
  const now = new Date();

  // Get day, month, year
  const day = String(now.getDate()).padStart(2, '0');       // 2-digit day
  const month = String(now.getMonth() + 1).padStart(2, '0'); // 2-digit month (0-based index)
  const year = now.getFullYear();

  // Get time components
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');

  // Format: DD/MM/YYYY HH:mm:ss
  return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
}


let justLoggedIn = false;

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  authMessage.textContent = "";
  authMessage.className = 'auth-message';

  isLoggingInNow = true;



  // Check if reCAPTCHA is completed
  const recaptchaResponse = grecaptcha.getResponse();
  if (!recaptchaResponse) {
    showMessage('Please verify you are not a robot.', 'error');
    return;
  }

  const emailInput = form.email.value.trim();
  const password = form.password.value.trim();

  if (!emailInput || !password) {
    showMessage('Please fill in all fields.', 'error');
    return;
  }

try {
  let emailToUse = emailInput;
  let userIdToUpdate = null;


  if (!isEmail(emailInput)) {
    // Lookup username in database
    const usersSnapshot = await get(ref(db, 'users'));
    if (!usersSnapshot.exists()) {
      showMessage('User not found.', 'error');
      return;
    }

    let foundEmail = null;
    let userIdToUpdate = null; // keep track of user key for db update

    usersSnapshot.forEach(userSnap => {
      const userData = userSnap.val();
      if (userData.email === emailInput) {
          foundEmail = userData.email;
          userIdToUpdate = userSnap.key; // save user id for db update
      }

    });

    if (!foundEmail) {
      showMessage('User not found.', 'error');
      return;
    }

    emailToUse = foundEmail;
  }

  // Try signing in with the resolved email
  const userCredential = await signInWithEmailAndPassword(auth, emailToUse, password);
  const user = userCredential.user;

  // Check email verified status and update database if verified
  if (user.emailVerified) {
    // user.uid can also be used, but here we use userIdToUpdate (from DB lookup) if available
    const uid = userIdToUpdate || user.uid;

    await update(ref(db, 'users/' + uid), {
      emailVerified: true
    });
  }


  showMessage('Login successful! Please wait...', 'success');

  // Logs the last time the user has logged in
  const userIp = await getClientIp();
  const ip = userIp || 'unknown';  // fallback
  const timestamp = getFormattedTimestamp();  // use your formatted timestamp function
  const logEntry = `${timestamp} | ${ip}`;
  const uid = userIdToUpdate || user.uid;

  await update(ref(db, 'users/' + uid), {
      last_login: logEntry
    });


  setTimeout(() => {
    window.location.href = redirectURL;
  }, 1500);

} catch (error) {
  showMessage(getCustomErrorMessage(error.message), 'error');

  // Log failed login attempt with IP and attempted email/username and timestamp
  const userIp = await getClientIp();
  const ip = userIp || 'unknown';  // fallback
  const timestamp = new Date().toISOString();

  // Log failed login attempts for users security
  const logRef = ref(logsDb, 'logs/failed_logins');
  const newLogRef = push(logRef);

  await set(newLogRef, {
    attemptedUser: emailInput,
    ip,
    timestamp: getFormattedTimestamp(),
    error: error.code || 'unknown_error'
  });
}
});


const forgotPasswordForm = document.getElementById('forgot-password-form');
const loginForm = document.getElementById('login-form');
const backToLoginLink = document.getElementById('back-to-login');

const forgotPasswordLink = document.getElementById('forgot-password-link');
const signupLink = document.querySelector('p a[href="signup.html"]');
const heading = document.querySelector('main.auth-container h1');

forgotPasswordLink.addEventListener('click', (e) => {
  e.preventDefault();
  loginForm.style.display = 'none';
  forgotPasswordForm.style.display = 'block';
  authMessage.textContent = '';

  // Update title and heading
  document.title = "Reset Password - Hack Harry";
  heading.textContent = "Reset Password";

  // Hide "Forgot Password?" and "Sign Up"
  forgotPasswordLink.style.display = 'none';
  signupLink.parentElement.style.display = 'none';
});


// Handle reset password submission
forgotPasswordForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('reset-email').value.trim();

  if (!email) {
    showMessage('Please enter your email address.', 'error');
    return;
  }

  try {
    await sendPasswordResetEmail(auth, email);
    showMessage('If an account with that email exists, a password reset email has been sent. Check your inbox!', 'success');

    // Log password reset attempt with IP and email and timestamp for users security
    const userIp = await getClientIp();
    const ip = userIp || 'unknown';  // fallback
    const timestamp = new Date().toISOString();

    const logRef = ref(logsDb, 'logs/password_resets');
    const newLogRef = push(logRef);

    await set(newLogRef, {
      email,
      ip,
      timestamp: getFormattedTimestamp()
    });
    
    // Wait 3 seconds before redirecting
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 3000);
  } catch (error) {
    // This shows same message for Email enumeration protection
    showMessage('If an account with that email exists, a password reset email has been sent. Check your inbox!', 'success');

    // Also log reset attempt in catch for completeness for users security
    const ip = await getClientIp();
    const timestamp = new Date().toISOString();

    const logRef = ref(logsDb, 'logs/password_resets');
    const newLogRef = push(logRef);

    await set(newLogRef, {
      email,
      ip,
      timestamp: getFormattedTimestamp(),
      error: error.code || 'unknown_error'
    });


    setTimeout(() => {
      window.location.href = 'login.html';
    }, 3000);
    }
});


// Back to login
backToLoginLink.addEventListener('click', (e) => {
  e.preventDefault();
  forgotPasswordForm.reset();
  forgotPasswordForm.style.display = 'none';
  loginForm.style.display = 'block';
  authMessage.textContent = '';

  // Restore title and heading
  document.title = "Login - Hack Harry";
  heading.textContent = "Login";

  // Show "Forgot Password?" and "Sign Up"
  forgotPasswordLink.style.display = '';
  signupLink.parentElement.style.display = '';
});


function showMessage(text, type) {
  authMessage.textContent = text;
  authMessage.className = 'auth-message visible ' + type;
}

</script>

</body>
</html>
